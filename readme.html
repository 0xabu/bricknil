
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>BrickNil - Control LEGO Bluetooth Sensors and Motors with Python &#8212; BrickNil 0.6 documentation</title>
    <link rel="stylesheet" href="_static/readable.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Development" href="contributing.html" />
    <link rel="prev" title="BrickNil Docs (version 0.6)" href="index.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="contributing.html" title="Development"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="BrickNil Docs (version 0.6)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">BrickNil 0.6 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="bricknil-control-lego-bluetooth-sensors-and-motors-with-python">
<h1>BrickNil - Control LEGO Bluetooth Sensors and Motors with Python<a class="headerlink" href="#bricknil-control-lego-bluetooth-sensors-and-motors-with-python" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://pypi.python.org/pypi/bricknil"><img alt="image_pypi" src="https://img.shields.io/pypi/v/bricknil.svg" /></a> <img alt="image_downloads" src="https://img.shields.io/pypi/dd/bricknil.svg" /> <a class="reference external" href="https://www.apache.org/licenses/LICENSE-2.0"><img alt="image_license" src="https://img.shields.io/pypi/l/bricknil.svg" /></a> <img alt="passing" src="https://scrutinizer-ci.com/g/virantha/bricknil/badges/build.png?b=master" /> <a class="reference external" href="https://scrutinizer-ci.com/g/virantha/bricknil"><img alt="quality" src="https://scrutinizer-ci.com/g/virantha/bricknil/badges/quality-score.png?b=master" /></a> <a class="reference external" href="https://coveralls.io/r/virantha/bricknil"><img alt="Coverage Status" src="https://img.shields.io/coveralls/github/virantha/bricknil.svg" /></a></p>
<p>BrickNil <a class="footnote-reference" href="#id2" id="id1">[*]</a> provides an easy way to connect to and program LEGO®
Bluetooth hubs (including the PoweredUp Passenger Train <a class="reference external" href="https://www.amazon.com/gp/product/B07CC37F63/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07CC37F63">60197</a> and Cargo Train <a class="reference external" href="https://www.amazon.com/gp/product/B07C39LCZ9/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07C39LCZ9">60198</a> sets, and the Lego
Duplo Steam Train <a class="reference external" href="https://www.amazon.com/gp/product/B07BK6M2WC/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07BK6M2WC">10874</a> and Cargo Train <a class="reference external" href="https://www.amazon.com/gp/product/B07BK6KQR6/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07BK6KQR6">10875</a> ) using Python on OS X and
Linux.  This work was inspired by this <a class="reference external" href="https://www.eurobricks.com/forum/index.php?/forums/topic/162288-powered-up-a-tear-down/">EuroBricks</a> thread, and the NodeJS <a class="reference external" href="https://github.com/nathankellenicki/node-poweredup">Powered-Up</a>
library.  It requires modern Python (designed and tested for 3.7) and uses asynchronous
event programming built on top of the <a class="reference external" href="http://curio.readthedocs.io">Curio</a> async library.  As an aside, the choice of
async library is fairly arbitrary; and enabling another library such as asyncio or Trio
should be straightforward.</p>
<p>An example BrickNil program for controlling the Train motor speed is shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">bricknil</span> <span class="kn">import</span> <span class="n">attach</span><span class="p">,</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">TrainMotor</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># Repeat this control two times</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span> <span class="c1"># Ramp speed to 80 over 5 seconds</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Brake to 0 over 1 second</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;My train&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">start</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Free and open-source software: ASL2 license</li>
<li>Documentation: <a class="reference external" href="http://virantha.github.io/bricknil">http://virantha.github.io/bricknil</a></li>
<li>Source: <a class="reference external" href="https://github.com/virantha/bricknil">https://github.com/virantha/bricknil</a></li>
</ul>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[*]</a></td><td>BrickNil’s name comes from the word “Nil” (නිල්) in <a class="reference external" href="https://en.wikipedia.org/wiki/Sinhalese_language">Sinhala</a> which means Blue (as in Bluetooth)</td></tr>
</tbody>
</table>
<div class="section" id="features">
<h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Supports the following LEGO® Bluetooth systems:</dt>
<dd><ul class="first last">
<li>PoweredUp hubs for trains <a class="reference external" href="https://www.amazon.com/gp/product/B07CC37F63/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07CC37F63">60197</a>, <a class="reference external" href="https://www.amazon.com/gp/product/B07C39LCZ9/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07C39LCZ9">60198</a>, and <a class="reference external" href="https://www.amazon.com/gp/product/B07BK6M2WC/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07BK6M2WC">10874</a></li>
<li><a class="reference external" href="https://www.amazon.com/gp/product/B06Y6JCTKH/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B06Y6JCTKH">Boost</a> Move hub</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Supports the following actuators/sensors:</dt>
<dd><ul class="first last">
<li>Internal motors</li>
<li>Train motors</li>
<li>Hub LED color</li>
<li>Boost vision sensor (color, distance)</li>
<li>Internal tilt/orientation/accelerometer</li>
<li>Hub buttons</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Fully supports Python asynchronous keywords and coroutines</dt>
<dd><ul class="first last">
<li>Allows expressive concurrent programming using async/await syntax</li>
<li>The current implementation uses the async library <a class="reference external" href="http://curio.readthedocs.io">Curio</a> by David Beazley</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Cross-platform</dt>
<dd><ul class="first last">
<li>Uses the Adafruit Bluefruit BluetoothLE library for Mac OS X</li>
<li>Uses the Bleak Bluetooth library for Linux and Win10<a class="footnote-reference" href="#id8" id="id7">[†]</a>, tested on Raspberry Pi</li>
</ul>
</dd>
</dl>
</li>
</ul>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[†]</a></td><td>Untested</td></tr>
</tbody>
</table>
</div>
<div class="section" id="building-a-simple-train-controller">
<h2>Building a simple train controller<a class="headerlink" href="#building-a-simple-train-controller" title="Permalink to this headline">¶</a></h2>
<p>Let’s build a simple program to control a LEGO® PoweredUp train.  The first thing to do
is create a class that subclasses the Bluetooth hub that we’ll be using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>

<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

   <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> async function (it’s actually a coroutine) will contain the code that will control
everything attached to this hub.  Speaking of which, because we’ll be wanting to control the train
motor connected to this hub, we’d better attach it to the code like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">TrainMotor</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

   <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="o">...</span>
</pre></div>
</div>
<p>Now, we can access the motor functions by calling the object <cite>self.motor</cite> inside <cite>run</cite>.  For example,
let’s say that we wanted to set the motor speed to 50 (the allowed range is -100 to 100 where negative
numbers are reverse speeds):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">TrainMotor</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

   <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
      <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait 5 seconds before exiting</span>
</pre></div>
</div>
<p>Notice that we’re using the <cite>await</cite> keyword in front of all the calls, because
those are also asynchronous coroutines that will get run in the event loop.
At some point, the <a class="reference internal" href="_autosummary/bricknil.peripheral.html#bricknil.peripheral.Motor.set_speed" title="bricknil.peripheral.Motor.set_speed"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bricknil.peripheral.Motor.set_speed()</span></code></a> coroutine
will finish executing and control will return back to the statement after it.
The next statement is a call to the <cite>sleep</cite> coroutine from the <cite>curio</cite>
library. It’s important to use this, instead of the regular <em>function</em>
<cite>time.sleep</cite> because <cite>curio.sleep</cite> is a coroutine that will <strong>not</strong> block
other tasks from running.</p>
<p>Note that we can use arbitrary Python to build our controller; suppose that we
wanted to ramp the motor speed gradually to 80 over 5 seconds, and then reduce
speed back to a stop in 1 second, and then repeat it over again.  We could implement
the <cite>run</cite> logic as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="_autosummary/bricknil.peripheral.html#bricknil.peripheral.Motor.ramp_speed" title="bricknil.peripheral.Motor.ramp_speed"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bricknil.peripheral.Motor.ramp_speed()</span></code></a> function will ramp the speed from
whatever it is currently to the target speed over the millisecond duration given (internally, it will
change the train speed every 100ms).  Here, you can see how things are running concurrently:  we issue
the ramp_speed command, that will take 5 seconds to complete in the background,
so we need to make sure our control logic sleeps for 5 seconds too, to ensure
the train has enough time to get up to speed, before we issue the braking command.  Once the train
comes to a stop, it will stay stopped for 1 second, then repeat this sequence of speed changes
once more before exiting.</p>
<p>It’s also useful to print out what’s happening as we run our program. In order to facilitate that,
there is some rudimentary logging capability built-in to <cite>bricknil</cite> via the
<a class="reference internal" href="_autosummary/bricknil.process.html#bricknil.process.Process" title="bricknil.process.Process"><code class="xref py py-class docutils literal notranslate"><span class="pre">bricknil.process.Process</span></code></a> class that all of these concurrent processes are sub-classed from.
Here’s the run coroutine with logging statements via
<a class="reference internal" href="_autosummary/bricknil.process.html#bricknil.process.Process.message_info" title="bricknil.process.Process.message_info"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bricknil.process.Process.message_info()</span></code></a> enabled:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s2">&quot;Running&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s1">&#39;Increasing speed&#39;</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s1">&#39;Coming to a stop&#39;</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Of course, just running the above code isn’t quite enough to execute the
controller.  Once we have the controller logic implemented, we need to define
our entire system in a separate top-level coroutine like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;My train&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This coroutine instantiates all the hubs we want to control; once we have that,
we can go ahead and implement the full program that calls
<code class="xref py py-func docutils literal notranslate"><span class="pre">bricknil.start()</span></code> with this <cite>system</cite> coroutine:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">bricknil</span> <span class="kn">import</span> <span class="n">attach</span><span class="p">,</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">TrainMotor</span>
<span class="kn">from</span> <span class="nn">bricknil.process</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s2">&quot;Running&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s1">&#39;Increasing speed&#39;</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s1">&#39;Coming to a stop&#39;</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;My train&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="n">MSG_LEVEL</span><span class="o">.</span><span class="n">INFO</span>
    <span class="n">start</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this program will output the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BLE</span> <span class="n">Event</span> <span class="n">Q</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span> <span class="n">Looking</span> <span class="k">for</span> <span class="n">first</span> <span class="n">matching</span> <span class="n">hub</span>
<span class="n">BLE</span> <span class="n">Event</span> <span class="n">Q</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">device</span>
<span class="n">BLE</span> <span class="n">Event</span> <span class="n">Q</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span> <span class="n">Device</span> <span class="n">name</span> <span class="n">HUB</span> <span class="n">NO</span><span class="o">.</span><span class="mi">4</span>
<span class="n">BLE</span> <span class="n">Event</span> <span class="n">Q</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span> <span class="n">Device</span> <span class="nb">id</span> <span class="n">XXXX</span><span class="o">-</span><span class="n">XXXX</span>
<span class="n">BLE</span> <span class="n">Event</span> <span class="n">Q</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span> <span class="n">Device</span> <span class="n">advertised</span> <span class="p">[</span><span class="n">UUID</span><span class="p">(</span><span class="s1">&#39;XXXXX&#39;</span><span class="p">)]</span>
<span class="n">My</span> <span class="n">train</span><span class="o">.</span><span class="mi">2</span><span class="p">:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">peripheral</span> <span class="n">motor</span> <span class="n">to</span> <span class="n">attach</span> <span class="n">to</span> <span class="n">a</span> <span class="n">port</span>
<span class="n">My</span> <span class="n">train</span><span class="o">.</span><span class="mi">2</span><span class="p">:</span> <span class="n">Running</span>
<span class="n">My</span> <span class="n">train</span><span class="o">.</span><span class="mi">2</span><span class="p">:</span> <span class="n">Increasing</span> <span class="n">speed</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">ramp</span> <span class="n">of</span> <span class="n">speed</span><span class="p">:</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="mi">80</span> <span class="p">(</span><span class="mf">5.0</span><span class="n">s</span><span class="p">)</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">0</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">1</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">3</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">4</span>
<span class="o">...</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">80</span>
<span class="n">My</span> <span class="n">train</span><span class="o">.</span><span class="mi">2</span><span class="p">:</span> <span class="n">Coming</span> <span class="n">to</span> <span class="n">a</span> <span class="n">stop</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Starting</span> <span class="n">ramp</span> <span class="n">of</span> <span class="n">speed</span><span class="p">:</span> <span class="mi">76</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="p">(</span><span class="mf">1.0</span><span class="n">s</span><span class="p">)</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">76</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">68</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">60</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">53</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">45</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">38</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">30</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">22</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">15</span>
<span class="n">motor</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Setting</span> <span class="n">speed</span> <span class="n">to</span> <span class="mi">0</span>
<span class="o">...</span> <span class="n">repeats</span>
</pre></div>
</div>
</div>
<div class="section" id="integrating-a-vision-sensor-into-a-simple-train-controller">
<h2>Integrating a vision sensor into a simple train controller<a class="headerlink" href="#integrating-a-vision-sensor-into-a-simple-train-controller" title="Permalink to this headline">¶</a></h2>
<p>Now let’s build a controller that sets the speed of the train depending on how
close your hand is to a snensor, and will quit the program if you wave your hand
more than three times in front of it.</p>
<p>We’ll be using the Vision Sensor that comes with the LEGO Boost robotics kit;
plug the sensor into the second port of the train’s PoweredUP hub.  This sensor
has a multitude of different sensing abilities including distance and color,
but for this example, we’re just going to use the <cite>sense_count</cite> and
<cite>sense_distance</cite> capabilities.  The former measures how many times it sees
something pass in front of it at a distance of ~2 inches, while the latter
measures roughly how many inches something is from the sensor (from 1-10
inches).  For a full list of the supported capabilities, please see the API
documentation at <a class="reference internal" href="_autosummary/bricknil.sensor.html#bricknil.sensor.VisionSensor" title="bricknil.sensor.VisionSensor"><code class="xref py py-class docutils literal notranslate"><span class="pre">bricknil.sensor.VisionSensor</span></code></a>.</p>
<p>The full program is listed at the end of this section, but let’s just go through
it bit by bit.  The first thing we’ll do is attach the sensor to the Train class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@attach</span><span class="p">(</span><span class="n">VisionSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_count&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_distance&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>
     <span class="o">...</span>
</pre></div>
</div>
<p>Anytime you attach a sensor to the system (motion, tilt, color, etc), you need to define
what capabilities you want to enable; each sensor can physically provide different capabilities
depending on which sensor you’re using.  As soon as you attach a sensor, you need to provide
a call-back coroutine that will be called whenever the sensor detects a change like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@attach</span><span class="p">(</span><span class="n">VisionSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_count&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_distance&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">train_sensor_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The values will be provided in dictionary called <cite>self.value</cite> that is indexed by the capability.
Let’s look at a practical example, and implement the logic we were discussing above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@attach</span><span class="p">(</span><span class="n">VisionSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_count&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_distance&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">train_sensor_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">VisionSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_distance</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">VisionSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_count</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Wave your hand more than three times in front of the sensor and the program ends</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># The closer your hand gets to the sensor, the faster the motor runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">-</span><span class="n">distance</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>

        <span class="c1"># Flag a change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Here, we get the <cite>distance</cite> and <cite>count</cite> from the <cite>value</cite> dict.  If the <cite>count</cite> is greater than
3 (more than 3 hand waves), we set a flag that keeps the system running to <cite>False</cite>.  Next, based
on the inverse of the distance, we set a motor_speed instance variable, and then use <cite>self.sensor_change</cite>
to signal to the main <cite>run</cite> routine that a sensor update has happened.  Our <cite>run</cite> logic can now
use these values to implement the controller:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>  <span class="c1"># Ramp to new speed in 0.9 seconds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>We keep running the train while <cite>keep_running</cite> flag is <cite>True</cite>; if a <cite>sensor_change</cite> is detected,
we ramp the train speed to the new target <cite>self.motor_speed</cite> in 0.9 seconds, and then wait
for the next sensor update, whenever that may be, at intervals of 1 second.  As soon as you pass
your hand more than three times in front of the sensor, the program will exit this <cite>while</cite> loop
and end.</p>
<p>Here’s the full code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">bricknil</span> <span class="kn">import</span> <span class="n">attach</span><span class="p">,</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">TrainMotor</span><span class="p">,</span> <span class="n">VisionSensor</span>
<span class="kn">from</span> <span class="nn">bricknil.process</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">VisionSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_count&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_distance&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">train_sensor_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">VisionSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_distance</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">VisionSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_count</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Wave your hand more than three times in front of the sensor and the program ends</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># The closer your hand gets to the sensor, the faster the motor runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">-</span><span class="n">distance</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>

        <span class="c1"># Flag a change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span><span class="p">:</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>  <span class="c1"># Ramp to new speed in 0.9 seconds</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;My Train&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="n">MSG_LEVEL</span><span class="o">.</span><span class="n">INFO</span>
    <span class="n">start</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="further-examples">
<h2>Further examples<a class="headerlink" href="#further-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="connecting-to-a-specific-hub">
<h3>Connecting to a specific hub<a class="headerlink" href="#connecting-to-a-specific-hub" title="Permalink to this headline">¶</a></h3>
<p>If you know the BluetoothLE network address of the hub you want to connect to, then you can force a Hub object
to only connect to that hub.  This can be useful, for example, for connecting to two trains that need to have different
code and can be accomplished by passing in the <code class="docutils literal notranslate"><span class="pre">ble_id</span></code> argument like so during instantiation of the Hub:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">hub</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;train1&#39;</span><span class="p">,</span> <span class="n">ble_id</span><span class="o">=</span><span class="s1">&#39;05c5e50e-XXXX-XXXX-XXXX-XXXXXXXXXXXX&#39;</span><span class="p">)</span>
    <span class="n">hub</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;train2&#39;</span><span class="p">,</span> <span class="n">ble_id</span><span class="o">=</span><span class="s1">&#39;05c5e50e-YYYY-YYYY-YYYY-YYYYYYYYYYYY&#39;</span><span class="p">)</span>
    <span class="n">hub</span> <span class="o">=</span> <span class="n">CargoTrain</span><span class="p">(</span><span class="s1">&#39;train3&#39;</span><span class="p">,</span> <span class="n">ble_id</span><span class="o">=</span><span class="s1">&#39;05c5e50e-ZZZZ-ZZZZ-ZZZZ-ZZZZZZZZZZZZ&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="hub-buttons-and-led-colors">
<h3>Hub buttons and LED colors<a class="headerlink" href="#hub-buttons-and-led-colors" title="Permalink to this headline">¶</a></h3>
<p>Here’s an example that enables the train motor, vision sensor, hub button, and hub LED.  First,
we’ll wait until the hub button is pressed before we do anything; the LED will blink purple and yellow
while it’s waiting.  Then, we’ll change the speed like the previous example based on the vision distance,
while at the same time changing the LED color orange if it’s responding to a distance change.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">bricknil</span> <span class="kn">import</span> <span class="n">attach</span><span class="p">,</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">TrainMotor</span><span class="p">,</span> <span class="n">VisionSensor</span><span class="p">,</span> <span class="n">Button</span><span class="p">,</span> <span class="n">LED</span>
<span class="kn">from</span> <span class="nn">bricknil.process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">bricknil.const</span> <span class="kn">import</span> <span class="n">Color</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">Button</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_btn&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_press&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_led&#39;</span><span class="p">)</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">VisionSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;train_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_count&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_distance&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">TrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">PoweredUpHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">train_btn_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;train button push {self.train_btn.value}&#39;</span><span class="p">)</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_btn</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">Button</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_press</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">btn</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Pushed!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">go</span> <span class="o">=</span> <span class="bp">True</span>


    <span class="n">async</span> <span class="k">def</span> <span class="nf">train_sensor_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Train sensor value change {self.train_sensor.value}&#39;</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">VisionSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_distance</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">VisionSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_count</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Wave your hand more than three times in front of the sensor and the program ends</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># The closer your hand gets to the sensor, the faster the motor runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="o">-</span><span class="n">distance</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>

        <span class="c1"># Flag a change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s2">&quot;Running&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">go</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Blink the color  from purple and yellow</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="n">Color</span><span class="o">.</span><span class="n">purple</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">yellow</span><span class="p">])</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">go</span><span class="p">:</span>  <span class="c1"># Wait until the hub button is pushed</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_led</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="n">Color</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">orange</span><span class="p">])</span>
        <span class="c1"># Ready to go, let&#39;s change the color to green!</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_running</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span><span class="p">:</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_led</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">motor_speed</span><span class="p">,</span> <span class="mi">900</span><span class="p">)</span>  <span class="c1"># Ramp to new speed in 0.9 seconds</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sensor_change</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_led</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;My Train&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">start</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="controlling-vernie-boost-hub-with-the-poweredup-remote">
<h3>Controlling Vernie (Boost Hub) with the PoweredUp Remote<a class="headerlink" href="#controlling-vernie-boost-hub-with-the-poweredup-remote" title="Permalink to this headline">¶</a></h3>
<p>Here’s a nice example of controlling two hubs (the remote is also a type of hub) and
feeding the button presses of the remote to make Vernie move forward, backward, left, and right.</p>
<div style="position: relative; height: 0; overflow: hidden; max-width: 100%; height: auto;">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/Mme2gFRiMI0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div><p>And here’s the code that’s being used in the video above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">bricknil</span> <span class="kn">import</span> <span class="n">attach</span><span class="p">,</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">PoweredUpRemote</span><span class="p">,</span> <span class="n">BoostHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">InternalMotor</span><span class="p">,</span> <span class="n">RemoteButtons</span><span class="p">,</span> <span class="n">LED</span><span class="p">,</span> <span class="n">Button</span>
<span class="kn">from</span> <span class="nn">bricknil.process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">bricknil.const</span> <span class="kn">import</span> <span class="n">Color</span>


<span class="nd">@attach</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;led&#39;</span><span class="p">)</span> 
<span class="nd">@attach</span><span class="p">(</span><span class="n">RemoteButtons</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;btns_right&#39;</span><span class="p">,</span>  <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_press&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">RemoteButtons</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;btns_left&#39;</span><span class="p">,</span>  <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_press&#39;</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">Remote</span><span class="p">(</span><span class="n">PoweredUpRemote</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">btns_left_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">btns_left</span><span class="o">.</span><span class="n">plus_pressed</span><span class="p">():</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_robot</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">btns_left</span><span class="o">.</span><span class="n">minus_pressed</span><span class="p">():</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_robot</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;backward&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_robot</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">btns_right_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">btns_right</span><span class="o">.</span><span class="n">plus_pressed</span><span class="p">():</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_robot</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">btns_right</span><span class="o">.</span><span class="n">minus_pressed</span><span class="p">():</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_robot</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell_robot</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;Running&#39;</span><span class="p">)</span>
        <span class="c1"># Set the remote LED to green to show we&#39;re ready</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">Color</span><span class="o">.</span><span class="n">green</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>   <span class="c1"># Keep the remote running</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;led&#39;</span><span class="p">)</span> 
<span class="nd">@attach</span><span class="p">(</span><span class="n">InternalMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor_right&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">InternalMotor</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">InternalMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor_left&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">InternalMotor</span><span class="o">.</span><span class="n">Port</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Robot</span><span class="p">(</span><span class="n">BoostHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">&quot;Running&quot;</span><span class="p">)</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="c1"># Set the robot LED to green to show we&#39;re ready</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">Color</span><span class="o">.</span><span class="n">green</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_remote</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_remote</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">==</span><span class="s1">&#39;forward&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;going forward&#39;</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_left</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_right</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">==</span><span class="s1">&#39;backward&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;going backward&#39;</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_left</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="o">-</span><span class="n">speed</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_right</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="o">-</span><span class="n">speed</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">==</span><span class="s1">&#39;stop&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_left</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_right</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">==</span><span class="s1">&#39;left&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_left</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="o">-</span><span class="n">speed</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_right</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">==</span><span class="s1">&#39;right&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_left</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor_right</span><span class="o">.</span><span class="n">set_speed</span><span class="p">(</span><span class="o">-</span><span class="n">speed</span><span class="p">)</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">robot</span> <span class="o">=</span> <span class="n">Robot</span><span class="p">(</span><span class="s1">&#39;Vernie&#39;</span><span class="p">)</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="n">Remote</span><span class="p">(</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
    
    <span class="c1"># Define a message passing queue from the remote to the robot</span>
    <span class="n">remote</span><span class="o">.</span><span class="n">tell_robot</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">listen_remote</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">tell_robot</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">start</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we are using two hubs running in parallel, and we use a <cite>curio.Queue</cite> to send messages
from the remote telling the robot(Boost hub) what to do. Notice that each RemoteButtons
instance consists of 3 buttons, so there are some helper methods to check if a particular
button is pressed.</p>
</div>
<div class="section" id="using-the-duplo-train-and-playing-sounds">
<h3>Using the Duplo Train and Playing Sounds<a class="headerlink" href="#using-the-duplo-train-and-playing-sounds" title="Permalink to this headline">¶</a></h3>
<p>The Duplo trains <a class="reference external" href="https://www.amazon.com/gp/product/B07BK6M2WC/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07BK6M2WC">10874</a> and <a class="reference external" href="https://www.amazon.com/gp/product/B07BK6KQR6/ref=as_li_tl?ie=UTF8&amp;tag=virantha-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07BK6KQR6">10875</a> have the ability to play a set of 5
predetermined sounds through their built-in speakers
(<a class="reference internal" href="_autosummary/bricknil.sensor.html#bricknil.sensor.DuploSpeaker" title="bricknil.sensor.DuploSpeaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">bricknil.sensor.DuploSpeaker</span></code></a>).  In addition, there is a
speedometer(<a class="reference internal" href="_autosummary/bricknil.sensor.html#bricknil.sensor.DuploSpeedSensor" title="bricknil.sensor.DuploSpeedSensor"><code class="xref py py-class docutils literal notranslate"><span class="pre">bricknil.sensor.DuploSpeedSensor</span></code></a>) built-in to the front
wheels, and a vision sensor(<a class="reference internal" href="_autosummary/bricknil.sensor.html#bricknil.sensor.DuploVisionSensor" title="bricknil.sensor.DuploVisionSensor"><code class="xref py py-class docutils literal notranslate"><span class="pre">bricknil.sensor.DuploVisionSensor</span></code></a>) in the
undercarriage pointing straight down.  This vision sensor is slightly less
capable than the stand-alone Boost Vision Sensor discussed above, but it can
still recognize colors, distance, and the special blocks that Lego provides in
those sets.  Here’s an example that puts everything together:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">curio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">bricknil</span> <span class="kn">import</span> <span class="n">attach</span><span class="p">,</span> <span class="n">start</span>
<span class="kn">from</span> <span class="nn">bricknil.hub</span> <span class="kn">import</span> <span class="n">DuploTrainHub</span>
<span class="kn">from</span> <span class="nn">bricknil.sensor</span> <span class="kn">import</span> <span class="n">DuploTrainMotor</span><span class="p">,</span> <span class="n">DuploSpeedSensor</span><span class="p">,</span> <span class="n">LED</span><span class="p">,</span> <span class="n">DuploVisionSensor</span><span class="p">,</span> <span class="n">DuploSpeaker</span>
<span class="kn">from</span> <span class="nn">bricknil.const</span> <span class="kn">import</span> <span class="n">Color</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="nd">@attach</span><span class="p">(</span><span class="n">DuploSpeaker</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;speaker&#39;</span><span class="p">)</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">DuploVisionSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vision_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_color&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_ctag&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_reflectivity&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">LED</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;led&#39;</span><span class="p">)</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">DuploSpeedSensor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;speed_sensor&#39;</span><span class="p">,</span> <span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sense_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;sense_count&#39;</span><span class="p">])</span>
<span class="nd">@attach</span><span class="p">(</span><span class="n">DuploTrainMotor</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Train</span><span class="p">(</span><span class="n">DuploTrainHub</span><span class="p">):</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">speed_sensor_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">DuploSpeedSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_speed</span><span class="p">]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">DuploSpeedSensor</span><span class="o">.</span><span class="n">capability</span><span class="o">.</span><span class="n">sense_count</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Speed sensor changed speed: {speed} count: {count}&#39;</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">vision_sensor_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">DuploVisionSensor</span><span class="o">.</span><span class="n">capability</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">cap</span><span class="o">.</span><span class="n">sense_color</span><span class="p">]</span>
        <span class="n">ctag</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">cap</span><span class="o">.</span><span class="n">sense_ctag</span><span class="p">]</span>
        <span class="n">reflt</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_sensor</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">cap</span><span class="o">.</span><span class="n">sense_reflectivity</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Vision sensor changed color: {color} ctag: {ctag} reflt: {reflt}&#39;</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s2">&quot;Running&quot;</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="n">Color</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">purple</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">yellow</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="n">Color</span><span class="o">.</span><span class="n">white</span><span class="p">])</span>

        <span class="n">snd</span> <span class="o">=</span> <span class="n">DuploSpeaker</span><span class="o">.</span><span class="n">sounds</span>
        <span class="n">sounds</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="n">snd</span><span class="o">.</span><span class="n">brake</span><span class="p">,</span> <span class="n">snd</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">snd</span><span class="o">.</span><span class="n">water</span><span class="p">,</span> <span class="n">snd</span><span class="o">.</span><span class="n">horn</span><span class="p">,</span> <span class="n">snd</span><span class="o">.</span><span class="n">steam</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">colors</span><span class="p">))</span>       <span class="c1"># Cycle through the colors</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">speaker</span><span class="o">.</span><span class="n">play_sound</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">sounds</span><span class="p">))</span>  <span class="c1"># cycle through the sounds</span>
            <span class="n">tgt_speed</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">15</span>                        <span class="c1"># Keep increasing the speed</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">motor</span><span class="o">.</span><span class="n">ramp_speed</span><span class="p">(</span><span class="n">tgt_speed</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Set speed to {i}&quot;</span><span class="p">)</span>
            <span class="n">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">message_info</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">system</span><span class="p">():</span>
    <span class="n">hub</span> <span class="o">=</span> <span class="n">Train</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">start</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="bricknil-architecture">
<h2>BrickNil Architecture<a class="headerlink" href="#bricknil-architecture" title="Permalink to this headline">¶</a></h2>
<p>This section documents the internal architecture of BrickNil and how all the components communicate with
each other.</p>
<div class="section" id="run-loops">
<h3>Run loops<a class="headerlink" href="#run-loops" title="Permalink to this headline">¶</a></h3>
<p>There are actually two threads of execution in the current system architecture.
The main Bluetooth radio communication loop is provided by the BluetoothLE
library, which manages everything in the background and can callback directly
into user code.  In parallel with this, inside this library, a separate
execution loop is running the Curio event library, which provides the async
event loop that executes our user code. Thus, we need to be careful about
maintaining thread safety between the Curio async event loop and the background
Bluetooth event processing.</p>
<div class="figure align-center" id="id9">
<img alt="_images/run_loops.svg" src="_images/run_loops.svg" /><p class="caption"><span class="caption-text">BrickNil running inside Curio’s event loop, which in turn is run by the
Adafruit_BluefruitLE library run loop</span></p>
</div>
<p>I’d much have preferred to have the Bluetooth library be implemented via an
async library like Curio, asyncio, or Trio, but I wasn’t able to find any such
library. This admitted kludge of nested run loops was the only way I could get everything
working.</p>
</div>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>On Mac OS X, it should just be a simple:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pip install bricknil
</pre></div>
</div>
<p>Installing on other platforms like Linux is not supported at this time until I can break out the
mac requirements, and test bluez.</p>
</div>
<div class="section" id="disclaimer">
<h2>Disclaimer<a class="headerlink" href="#disclaimer" title="Permalink to this headline">¶</a></h2>
<p>The software is distributed on an “AS IS” BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  Licensed under ASL 2.0</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">BrickNil - Control LEGO Bluetooth Sensors and Motors with Python</a><ul>
<li><a class="reference internal" href="#features">Features</a></li>
<li><a class="reference internal" href="#building-a-simple-train-controller">Building a simple train controller</a></li>
<li><a class="reference internal" href="#integrating-a-vision-sensor-into-a-simple-train-controller">Integrating a vision sensor into a simple train controller</a></li>
<li><a class="reference internal" href="#further-examples">Further examples</a><ul>
<li><a class="reference internal" href="#connecting-to-a-specific-hub">Connecting to a specific hub</a></li>
<li><a class="reference internal" href="#hub-buttons-and-led-colors">Hub buttons and LED colors</a></li>
<li><a class="reference internal" href="#controlling-vernie-boost-hub-with-the-poweredup-remote">Controlling Vernie (Boost Hub) with the PoweredUp Remote</a></li>
<li><a class="reference internal" href="#using-the-duplo-train-and-playing-sounds">Using the Duplo Train and Playing Sounds</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bricknil-architecture">BrickNil Architecture</a><ul>
<li><a class="reference internal" href="#run-loops">Run loops</a></li>
</ul>
</li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#disclaimer">Disclaimer</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation index</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">BrickNil Docs (version 0.6)</a></li>
      <li>Next: <a href="contributing.html" title="next chapter">Development</a></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/readme.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2019, Virantha N. Ekanayake.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
  </div>
  
  </body>
</html>